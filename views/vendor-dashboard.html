<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vendor Dashboard - TheTrend</title>
  <link rel="stylesheet" href="/public/css/vendor.css">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet"/>
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/views/home.html" class="brand">TheTrend</a>
      </div>

      <div class="vendor-profile">
        <div class="profile-avatar">
          <i class="ri-user-line"></i>
        </div>
        <h3 class="vendor-name" id="vendorName">Vendor Name</h3>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-section="overview">
          <i class="ri-dashboard-line"></i>
          <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item" data-section="products">
          <i class="ri-shopping-bag-line"></i>
          <span>Products</span>
        </a>
        <a href="#" class="nav-item" data-section="orders">
          <i class="ri-file-list-line"></i>
          <span>Orders</span>
        </a>
        <a href="#" class="nav-item" data-section="analytics">
          <i class="ri-bar-chart-line"></i>
          <span>Analytics</span>
        </a>
        <a href="#" class="nav-item" data-section="settings">
          <i class="ri-settings-line"></i>
          <span>Settings</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <button class="btn-logout" onclick="logout()">
          <i class="ri-logout-box-line"></i>
          <span>Logout</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header -->
      <header class="dashboard-header">
        <div class="header-left">
          <h1 class="page-title">Overview</h1>
          <span class="badge-live">LIVE</span>
        </div>
        <div class="header-right">
          <div class="search-box">
            <i class="ri-search-line"></i>
            <input type="text" placeholder="Search products...">
          </div>
          <button class="btn-icon" aria-label="Notifications">
            <i class="ri-notification-line"></i>
          </button>
          <button class="btn-primary" onclick="showAddProductModal()">
            <i class="ri-add-line"></i>
            Add Product
          </button>
        </div>
      </header>

      <!-- Overview Section -->
      <section class="content-section" id="overview-section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon" style="background: #e8f5e9;">
              <i class="ri-shopping-bag-line" style="color: #4caf50;"></i>
            </div>
            <div class="stat-info">
              <h3 id="totalProducts">0</h3>
              <p>Total Products</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon" style="background: #e3f2fd;">
              <i class="ri-file-list-line" style="color: #2196f3;"></i>
            </div>
            <div class="stat-info">
              <h3 id="totalOrders">0</h3>
              <p>Total Orders</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon" style="background: #fff3e0;">
              <i class="ri-money-dollar-circle-line" style="color: #ff9800;"></i>
            </div>
            <div class="stat-info">
              <h3 id="totalRevenue">$0</h3>
              <p>Total Revenue</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon" style="background: #fce4ec;">
              <i class="ri-star-line" style="color: #e91e63;"></i>
            </div>
            <div class="stat-info">
              <h3 id="avgRating">4.5</h3>
              <p>Avg Rating</p>
            </div>
          </div>
        </div>

        <!-- Products Table -->
        <div class="table-container">
          <div class="table-header">
            <h2>Your Products</h2>
            <button class="btn-secondary" onclick="loadProducts()">
              <i class="ri-refresh-line"></i>
              Refresh
            </button>
          </div>

          <div class="products-table" id="productsTable">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
                    Loading products...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add Product Modal -->
  <div class="modal" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Product</h2>
        <button class="btn-close" onclick="closeAddProductModal()">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <form id="addProductForm">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" name="name" placeholder="Enter product name" required>
        </div>
        <div class="form-group">
          <label>Price ($)</label>
          <input type="number" name="price" placeholder="0.00" step="0.01" min="0" required>
        </div>
        <div class="form-group">
          <label>Stock Quantity</label>
          <input type="number" name="stock" placeholder="0" min="0" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" placeholder="Product description" rows="3" required></textarea>
        </div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" name="image" placeholder="/public/images/products/product.png">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="closeAddProductModal()">Cancel</button>
          <button type="submit" class="btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/public/js/auth.js"></script>
  <script>
    const API_URL = 'http://localhost:4000';
    
    // Check if user is vendor
    const user = getCurrentUser();
    if (!user || user.role !== 'vendor') {
      alert('Access denied. Vendor account required.');
      window.location.href = '/views/login.html';
    }
    
    // Update vendor name
    document.getElementById('vendorName').textContent = user.username;
    
    // Load products on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadProducts();
      loadStats();
    });
    
    // Load vendor's products
    async function loadProducts() {
      try {
        const response = await fetch(`${API_URL}/products/vendor/${user.id}`);
        const products = await response.json();
        
        displayProducts(products);
      } catch (error) {
        console.error('Error loading products:', error);
      }
    }
    
    // Display products in table
    function displayProducts(products) {
      const tbody = document.getElementById('productsTableBody');
      
      if (products.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #999;">
              No products yet. Click "Add Product" to get started!
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = products.map(product => `
        <tr>
          <td>
            <div class="product-cell">
              <img src="${product.image || '/public/images/products/shirt1.png'}" alt="${product.name}">
              <span>${product.name}</span>
            </div>
          </td>
          <td>$${parseFloat(product.price).toFixed(2)}</td>
          <td>${product.stock}</td>
          <td>
            <span class="status-badge ${product.stock > 0 ? 'status-active' : 'status-inactive'}">
              ${product.stock > 0 ? 'In Stock' : 'Out of Stock'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon-small" onclick="editProduct(${product.id})" title="Edit">
                <i class="ri-edit-line"></i>
              </button>
              <button class="btn-icon-small btn-danger" onclick="deleteProduct(${product.id})" title="Delete">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // Load dashboard stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/products/vendor/${user.id}`);
        const products = await response.json();
        
        document.getElementById('totalProducts').textContent = products.length;
        
        const totalValue = products.reduce((sum, p) => sum + (parseFloat(p.price) * p.stock), 0);
        document.getElementById('totalRevenue').textContent = `$${totalValue.toFixed(0)}`;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }
    
    // Show add product modal
    function showAddProductModal() {
      document.getElementById('addProductModal').classList.add('active');
    }
    
    // Close add product modal
    function closeAddProductModal() {
      document.getElementById('addProductModal').classList.remove('active');
      document.getElementById('addProductForm').reset();
    }
    
    // Add product form submission
    document.getElementById('addProductForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const productData = {
        vendor_id: user.id,
        name: formData.get('name'),
        price: parseFloat(formData.get('price')),
        stock: parseInt(formData.get('stock')),
        description: formData.get('description'),
        image: formData.get('image') || '/public/images/products/shirt1.png'
      };
      
      try {
        const response = await fetch(`${API_URL}/products/add`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(productData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('✅ Product added successfully!');
          closeAddProductModal();
          loadProducts();
          loadStats();
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        console.error('Error adding product:', error);
        alert('❌ Failed to add product');
      }
    });
    
    // Delete product
    async function deleteProduct(productId) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const response = await fetch(`${API_URL}/products/delete/${productId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('✅ Product deleted successfully!');
          loadProducts();
          loadStats();
        } else {
          alert('❌ ' + data.message);
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert('❌ Failed to delete product');
      }
    }
    
    // Edit product (placeholder)
    function editProduct(productId) {
      alert(`Edit product ${productId} - Feature coming soon!`);
    }
    
    // Sidebar navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        const section = item.dataset.section;
        document.querySelector('.page-title').textContent = 
          section.charAt(0).toUpperCase() + section.slice(1);
      });
    });
  </script>
</body>
</html>
